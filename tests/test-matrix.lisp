(in-package :mare5x.lispqr.matrix)

(defparameter *draw-debug-path* "test-matrix/")

(defmacro deftest (name lambda-list &body body)
  "Wrapper for creating functions that use draw-debug."
  `(defun ,name ,lambda-list
     (defparameter *draw-debug* t)
     ,@body
     (defparameter *draw-debug* nil)))

;; Data for encoding "HELLO WORLD" in alphanumeric mode, version 7, ec-level :Q.
;; Data taken from https://www.nayuki.io/page/creating-a-qr-code-step-by-step.
;; This proves that image generation and make-qr-matrix are both correct.
(defparameter *data* #*00100000111011001110110000010001111011000001000101011011000100010001000111101100000100011110110000001011111011001110110000010001111011000001000101111000000100010001000111101100000100011110110011010001111011001110110000010001111011000001000101110010000100010001000111101100000100011110110011011100111011001110110000010001111011000001000101001101000100010001000111101100000100011110110001000011111011001110110000010001111011000001000101000000000100010001000111101100000100011110110011101100111011001110110000010001111011000001000100010001000100010001000111101100000100011110110011101100111011001110110000010001111011000001000100010001000100010001000111101100000100011110110011101100000100011110110000010001111111000110001100100101000010000010010100001000110110110011001110011100011111111001110001111111110000111001010000000110001110100000011000111010110011100110010011101010110101011110101011010101110110000010110111000010010001011100001001000101110000001001001100001000010101100000100001010110110111110111111011000101110100011100010111010001001111111110111110011111001000101001111100100010011110001010110111110111000001001111011100000100010111010111111111010100110011101101010011001110010011010110011010100100010010111010010001001011110000010100011110111110111001011011111011100101000101001100010101111111010100100111111101010010001101100000101011101111011101011110111101110101110000100000111110011101111101011001110111110101100011101010110111101011111111011110101111111101110101000000011111010000110111111101000011011111111110001110101111011011000000001101101100000000)

(deftest test-full ()
  (draw-debug-matrix (make-qr-matrix *data* 7 :Q 0) "HELLOWORLD-v7-Q"))

(defun test-format-info-strings ()
  (loop for ec-level in '(:L :M :Q :H) do
        (loop for mask-number below 8 do
              (format t "~a ~a ~a~%" ec-level mask-number (generate-format-bits ec-level mask-number)))))

(deftest write-mask-patterns (version &key (directory "./"))
  (let ((matrix (init-matrix (version-size version))))
    (loop for i from 0 below 8 
          for pattern = (mask-pattern matrix (mask-pattern-test-fn i))
          for path = (merge-pathnames directory
                                      (make-pathname :name (format nil "mask-pattern-~d" i)
                                                     :type "png"))
          do (write-qr-matrix path pattern))))

(deftest test-full-example ()
  ;; Default Alphanumeric mode example from https://www.nayuki.io/page/creating-a-qr-code-step-by-step

  (draw-debug-matrix (make-qr-matrix (mare5x.lispqr.encode::encode "PROJECT NAYUKI" :version 2 :ec-level :H)
                                     2 :H 3)
                     "PROJECT-NAYUKI-v2-H-3"))


